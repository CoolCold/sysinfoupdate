#!/bin/bash

# Main vars for configuration
DIARIO=${HOME}/diario/

# $1 - procfile
# $2 - File to log
function cat-file () {
    CAT=/bin/cat

    echo $1 >> $2
    if [ -e $1 ] ; then
	${CAT} $1 >> $2
    else
	echo "$1 don't exist" >> $2
    fi
    echo >> $2
}

function packages-list-update () {
    FILE="${DIARIO}/packages-list"

    if [ -d "${DIARIO}" ] ; then
	echo -n "."
	COLUMNS=132 dpkg --list > "${FILE}"
    fi

}

function partition-update () {
    FDISK=/sbin/fdisk
    CP=/bin/cp
    MOUNT=/bin/mount
    DF=/bin/df
    FILEPART=${DIARIO}/part-list
    FILEFSTAB=${DIARIO}/fstab
    FILEFS=${DIARIO}/fs-list

    echo -n "."
    > ${FILEPART}
    for disk in hda hdb hdc hdd hde hdf hdg hdh sda sdb sdc sdd sde sdf sdg sdh sdi sdj cciss/c?d? cciss/disc?/disc ; do
	fdisk -l /dev/${disk} >> ${FILEPART} 2>/dev/null
    done
    echo -n "."
    > ${FILEFS}
    echo "mounted partitions"           >> ${FILEFS}
    ${MOUNT} -l                         >> ${FILEFS}
    echo "size of filesystems df -h"    >> ${FILEFS}
    ${DF} -h                            >> ${FILEFS}
    echo "inodes of filesystems df -iH" >> ${FILEFS}
    ${DF} -iH                           >> ${FILEFS}   

    ${CP} /etc/fstab ${FILEFSTAB}
}

function lvm-update () {
    VGDISPLAY=/sbin/vgdisplay
    FILELVM=${DIARIO}/lvm-list
    > ${FILELVM}

    echo -n "."
    if [ -x ${VGDISPLAY} ] ; then
	${VGDISPLAY} --short   >> ${FILELVM} 2>&1
	${VGDISPLAY} --verbose >> ${FILELVM} 2>&1
    fi
}

function md-update () {
    MDADM=/sbin/mdadm
    FILEMD=${DIARIO}/md-list
    > ${FILEMD}
    
    echo -n "."
    if [ ! -x ${MDADM} ] ; then
	return
    fi
    ${MDADM} mdadm --detail /dev/md* >> ${FILEMD} 2>&1
    cat-file /proc/mdstat      ${FILEMD}
    cat-file /proc/sys/dev/raid/speed_limit_max ${FILEMD}
    cat-file /proc/sys/dev/raid/speed_limit_min ${FILEMD}
}

function kernel-update () {
    FILEKERNEL=${DIARIO}/kernel-list
    CAT=/bin/cat
    LSMOD=/sbin/lsmod
    FREE=/usr/bin/free
    AFSD1=/usr/sbin/afsd
    AFSD2=/sbin/afsd

    echo -n "."
    >${FILEKERNEL}
    cat-file /proc/version     ${FILEKERNEL}
    cat-file /proc/cmdline     ${FILEKERNEL}
    cat-file /proc/crypto      ${FILEKERNEL}
    cat-file /proc/devices     ${FILEKERNEL}
    ${LSMOD}             >>    ${FILEKERNEL}
    echo                 >>    ${FILEKERNEL}
    cat-file /proc/fb          ${FILEKERNEL}
    cat-file /proc/locks       ${FILEKERNEL}
    cat-file /proc/execdomains ${FILEKERNEL}
    echo "free"          >>    ${FILEKERNEL}
    ${FREE}              >>    ${FILEKERNEL}
    cat-file /proc/meminfo     ${FILEKERNEL}
    cat-file /proc/mtrr        ${FILEKERNEL}
    cat-file /proc/lvm/global  ${FILEKERNEL}
    cat-file /proc/swaps       ${FILEKERNEL}
    cat-file /proc/filesystems ${FILEKERNEL}

    echo "OpenAFS client"               >> ${FILEKERNEL}
    if [ -x ${AFSD1} ] ; then
	strings ${AFSD1} | grep built   >> ${FILEKERNEL}
    fi
    if [ -x ${AFSD2} ] ; then
	strings ${AFSD2} | grep built   >> ${FILEKERNEL}
    fi
    echo "OpenAFS modules"              >> ${FILEKERNEL}
    if which rxdebug > /dev/null ; then
	rxdebug localhost 7001 -version >> ${FILEKERNEL}
    fi
    echo "OpenAFS cache settings"       >> ${FILEKERNEL}
    if which cmdebug > /dev/null ; then
	cmdebug localhost -cache        >> ${FILEKERNEL}
    fi
    echo "/proc/sys"                            >> ${FILEKERNEL}
    cat-file /proc/sys/kernel/randomize_va_space   ${FILEKERNEL}
    cat-file /proc/sys/kernel/tainted              ${FILEKERNEL}
    cat-file /proc/sys/kernel/random/entropy_avail ${FILEKERNEL}
    cat-file /proc/sys/kernel/random/poolsize      ${FILEKERNEL}
}

function kernel-boot () {
    FILEKERNELBOOT=${DIARIO}/kernel-boot
    DMESGLOG=/var/log/dmesg
    KERNELLOG=/var/log/kern.log
    DMESG=/bin/dmesg
    HEAD=/usr/bin/head
    GREP=/bin/grep
    MKTEMP=/bin/mktemp
    CP=/bin/cp
    CUT=/usr/bin/cut
    
    echo -n "."
    TMPFILE=`mktemp`
    $DMESG > ${TMPFILE}
    if $HEAD ${TMPFILE} | ${GREP} "Linux version" > /dev/null ; then
	${CP} ${TMPFILE} ${FILEKERNELBOOT}
    else
	if ${GREP} "Linux version" ${KERNELLOG}> /dev/null ; then
	    LMATCH=`grep -n "Linux version" /var/log/kern.log | tail -1 | cut -d: -f 1`
	    FSIZE=`wc -l /var/log/kern.log | cut -f 1 -d ' '`
	    tail --lines=$(( FSIZE - LMATCH + 1)) /var/log/kern.log | cut -d : -f 4- | cut -b 2- > ${FILEKERNELBOOT}
	else
	    if $HEAD /var/log/dmesg | ${GREP} "Linux version" > /dev/null ; then
		${CP} /var/log/dmesg ${FILEKERNELBOOT}
	    else
		echo "Could not find initial kernel boot message, ${DMESG} ${KERNELLOG} and ${DMESGLOG} did not help."
		echo 
		echo "See if exist an alternative."
		echo
		echo "If kernel boot messages are to big to fit in /proc/kmsg ring buffer, considerar to change runlevels of sysklogd, klogd and bootmisc.sh.  Sugestion: /etc/rcS.d/S40sysklog /etc/rcS.d/S41klogd /etc/rcS.d/S41bootmisc.sh"
	    fi
	fi
    fi
    if [ -e /var/log/boot ] ; then
	${CUT}  -d : -f 4- /var/log/boot | ${CUT} -b2- > ${DIARIO}/boot-log 
    fi
}

function hardware-update () {
    LSPCI=/usr/bin/lspci
    LSUSB=/usr/bin/lsusb
    HDPARM=/sbin/hdparm
    FILEPCI=${DIARIO}/pci-list
    FILEUSB=${DIARIO}/usb-list
    FILEALSA=${DIARIO}/alsa-list
    FILEHARDWARE=${DIARIO}/hardware-list
    FILEHDPARM=${DIARIO}/hdparm-list
    HPADUCLI=/usr/sbin/hpaducli
    HPASMCLI=/sbin/hpasmcli
    
    echo -n "."
    > ${FILEPCI}
    echo "#################### lspci "      >> ${FILEPCI}
    ${LSPCI}                                >> ${FILEPCI}
    echo "#################### lspci -tv"   >> ${FILEPCI}
    ${LSPCI} -tv                            >> ${FILEPCI}
    echo "#################### lspci -v"    >> ${FILEPCI}
    ${LSPCI} -v                             >> ${FILEPCI}
    echo "#################### lspci -vv"   >> ${FILEPCI}
    ${LSPCI} -vv                            >> ${FILEPCI}
    cat-file /proc/pci                         ${FILEPCI}
    ${LSPCI} -x                              > ${FILEPCI}-x
    cat-file /proc/bus/pci/devices             ${FILEPCI}-x
    
    > ${FILEUSB}
    if [ -x ${LSUSB} ] ; then
	${LSUSB}                            >> ${FILEUSB}
	${LSUSB} -t                         >> ${FILEUSB} 2>&1
	${LSUSB} -v                         >> ${FILEUSB}
    fi

    > ${FILEALSA}
    cat-file /proc/asound/version ${FILEALSA}
    cat-file /proc/asound/cards   ${FILEALSA}
    cat-file /proc/asound/devices ${FILEALSA}
    cat-file /proc/asound/modules ${FILEALSA}
    cat-file /proc/asound/pcm     ${FILEALSA}
    cat-file /proc/asound/timers  ${FILEALSA}

    > ${FILEHARDWARE}
    cat-file /proc/cpuinfo                    ${FILEHARDWARE}
    cat-file /proc/dma                        ${FILEHARDWARE}
    cat-file /proc/interrupts                 ${FILEHARDWARE}
    cat-file /proc/iomem                      ${FILEHARDWARE}
    cat-file /proc/ioports                    ${FILEHARDWARE}
    cat-file /proc/device-tree/compatible     ${FILEHARDWARE}
    echo                                   >> ${FILEHARDWARE}
    cat-file /proc/device-tree/model          ${FILEHARDWARE}
    echo                                   >> ${FILEHARDWARE}
    cat-file /proc/device-tree/serial-number  ${FILEHARDWARE}
    echo                                   >> ${FILEHARDWARE}
    cat-file /proc/bus/input/devices          ${FILEHARDWARE}
    cat-file /proc/bus/input/handlers         ${FILEHARDWARE}
    cat-file /proc/bus/ieee1394/devices       ${FILEHARDWARE}
    cat-file /proc/bus/usb/devices            ${FILEHARDWARE}
    cat-file /proc/bus/usb/drivers            ${FILEHARDWARE}
    cat-file /proc/ide/drivers                ${FILEHARDWARE}
    cat-file /proc/ide/via                    ${FILEHARDWARE}
    cat-file /proc/ide/piix                   ${FILEHARDWARE}
    cat-file /proc/ide/svwks                  ${FILEHARDWARE}
    cat-file /proc/scsi/scsi                  ${FILEHARDWARE}
    cat-file /proc/scsi/sg/version            ${FILEHARDWARE}
    cat-file /proc/scsi/sg/devices            ${FILEHARDWARE}
    cat-file /proc/scsi/sg/device_strs        ${FILEHARDWARE}
    cat-file /proc/driver/cciss/cciss0        ${FILEHARDWARE}
    cat-file /proc/driver/cciss/cciss1        ${FILEHARDWARE}
    cat-file /proc/scsi/3w-xxxx/0             ${FILEHARDWARE}
    cat-file /proc/pmu/info                   ${FILEHARDWARE}
    cat-file /proc/pmu/interrupts             ${FILEHARDWARE}
    cat-file /proc/pmu/options                ${FILEHARDWARE}
    cat-file /proc/dri/0/name                 ${FILEHARDWARE}
    cat-file /proc/dri/0/mem                  ${FILEHARDWARE}
    

    > ${FILEHDPARM}
    for disk in hda hdb hdc hdd hde hdf hdg hdh sda sdb sdc sdd sde sdf sdg sdh sdi sdj cciss/c?d? cciss/disc?/disc ; do
	${HDPARM}    /dev/${disk} >> ${FILEHDPARM} 2> /dev/null
	${HDPARM} -i /dev/${disk} >> ${FILEHDPARM} 2> /dev/null
	${HDPARM} -I /dev/${disk} >> ${FILEHDPARM} 2> /dev/null
    done
    
    if [ -x ${HPADUCLI} ] ; then
	${HPADUCLI} -f ${DIARIO}/hpadu-report
    fi
    if [ -x ${HPASMCLI} ] ;then
	${HPASMCLI} -s "SHOW ASR; SHOW BOOT; SHOW DIMM ; SHOW F1 ; SHOW FANS ; SHOW HT ; SHOW IML ; SHOW IPL ; SHOW NAME ; SHOW POWERSUPPLY ; SHOW PXE ; SHOW SERIAL  BIOS ;  SHOW SERIAL EMBEDDED ; SHOW SERIAL VIRTUAL ; SHOW SERVER ; SHOW TEMP ; ; SHOW WOL ;" > ${DIARIO}/hpasmcli-report < /dev/null
    fi
}

function hpacucli-update () {
    HPACUCLI=/usr/sbin/hpacucli
    FILEHPACUCLI=${DIARIO}/hpacucli-report
    TMPDIR=`mktemp -d`

    echo -n "."
    if [ ! -x ${HPACUCLI} ] ; then
	return
    fi
    > ${FILEHPACUCLI}
    echo "Controllers" >> ${FILEHPACUCLI}
    ${HPACUCLI} controller all show | tee -a ${FILEHPACUCLI} > ${TMPDIR}/hpacucli-controller


    echo -n "."
    cat ${TMPDIR}/hpacucli-controller | grep " at " | cut -f 3 -d ' ' | xargs -n 1 -i ${HPACUCLI} controller ch=\{\} show  >> ${FILEHPACUCLI}
    cat ${TMPDIR}/hpacucli-controller | grep " in Slot " | cut -f 6 -d ' ' | xargs -n 1 -i ${HPACUCLI} controller slot=\{\} show  >> ${FILEHPACUCLI}


    for target in `cat ${TMPDIR}/hpacucli-controller | grep " at " | cut -f 3 -d ' '` ; do
	echo -n "."
 	echo "Discs of controller at $target" >> ${FILEHPACUCLI}
 	${HPACUCLI} controller ch=${target} array all show | tee ${TMPDIR}/hpacucli-controller-at-${target}-array >> ${FILEHPACUCLI}
 	${HPACUCLI} controller ch=${target} ld all show | tee ${TMPDIR}/hpacucli-controller-at-${target}-ld >> ${FILEHPACUCLI}
 	${HPACUCLI} controller ch=${target} pd all show | tee ${TMPDIR}/hpacucli-controller-at-${target}-pd >> ${FILEHPACUCLI}
    done

    for target in `cat ${TMPDIR}/hpacucli-controller | grep " in Slot " | cut -f 6 -d ' '` ; do
	echo -n "."
 	echo "Discs of controller in Slot $target" >> ${FILEHPACUCLI}
 	${HPACUCLI} controller slot=${target} array all show | tee ${TMPDIR}/hpacucli-controller-slot-${target}-array >> ${FILEHPACUCLI}
 	${HPACUCLI} controller slot=${target} ld all show | tee ${TMPDIR}/hpacucli-controller-slot-${target}-ld >> ${FILEHPACUCLI}
 	${HPACUCLI} controller slot=${target} pd all show | tee ${TMPDIR}/hpacucli-controller-slot-${target}-pd >> ${FILEHPACUCLI}
    done


    for target in `cat ${TMPDIR}/hpacucli-controller | grep " at " | cut -f 3 -d ' '` ; do
	echo -n "."
 	echo "Detail of discs at $target" >> ${FILEHPACUCLI}
	for array in `grep -h array ${TMPDIR}/hpacucli-controller-at-${target}-array | awk '{print $2}'` ; do
	    #echo $ld
	    ${HPACUCLI} controller ch=${target} array $array show >> ${FILEHPACUCLI}
	done
	echo -n "."
	for ld in `grep -h logicaldrive ${TMPDIR}/hpacucli-controller-at-${target}-ld | awk '{print $2}'` ; do
	    #echo $ld
	    ${HPACUCLI} controller ch=${target} ld $ld show >> ${FILEHPACUCLI}
	done
	echo -n "."
	for pd in `grep -h physicaldrive ${TMPDIR}/hpacucli-controller-at-${target}-pd | awk '{print $2}'` ; do
	    #echo $pd
	    ${HPACUCLI} controller ch=${target} pd $pd show >> ${FILEHPACUCLI}
	done
    done

    for target in `cat ${TMPDIR}/hpacucli-controller | grep " in Slot " | cut -f 6 -d ' '` ; do
	echo -n "."
 	echo "Detail of discs in Slot $target" >> ${FILEHPACUCLI}
	for array in `grep -h "  array " ${TMPDIR}/hpacucli-controller-slot-${target}-array | awk '{print $2}'` ; do
	    #echo $ld
	    ${HPACUCLI} controller slot=${target} array $array show >> ${FILEHPACUCLI}
	done
	echo -n "."
	for ld in `grep -h "  logicaldrive " ${TMPDIR}/hpacucli-controller-slot-${target}-ld | awk '{print $2}'` ; do
	    #echo $ld
	    ${HPACUCLI} controller slot=${target} ld $ld show >> ${FILEHPACUCLI}
	done
	echo -n "."
	for pd in `grep -h "  physicaldrive " ${TMPDIR}/hpacucli-controller-slot-${target}-pd | awk '{print $2}'` ; do
	    #echo $pd
	    ${HPACUCLI} controller slot=${target} pd $pd show >> ${FILEHPACUCLI}
	done
    done
}

function hpacucli-update-7.6 () {
    HPACUCLI=/usr/sbin/hpacucli
    FILEHPACUCLI=${DIARIO}/hpacucli-report
    TMPDIR=`mktemp -d`

    echo -n "."
    if [ ! -x ${HPACUCLI} ] ; then
	return
    fi
    
    VERSION=`echo "exit" | ${HPACUCLI} | grep CLI | cut -d ' ' -f 6`
    V=`echo $VERSION | cut -d - -f 1`
    V1=`echo $V | cut -d . -f 1`
    V2=`echo $V | cut -d . -f 2`
    V3=`echo $V | cut -d . -f 3`
    if [ $V1 -lt 7 ] ; then
	hpacucli-update
	return
    fi

    if [ $V2 -lt 60 ] ; then
	hpacucli-update
	return
    fi

    > ${FILEHPACUCLI}
    echo "Controllers" >> ${FILEHPACUCLI}
    ${HPACUCLI} controller all show | tee -a ${FILEHPACUCLI} > ${TMPDIR}/hpacucli-controller

    echo -n "."
    ${HPACUCLI} controller all show detail >> ${FILEHPACUCLI} 

    echo -n "."
    ${HPACUCLI} controller all show config >> ${FILEHPACUCLI} 
    
    echo -n "."
    ${HPACUCLI} controller all show config detail >> ${FILEHPACUCLI} 
}




function net-update () {
    FILENET=${DIARIO}/net-list
    IFCONFIG=/sbin/ifconfig
    ROUTE=/sbin/route
    IP=/sbin/ip
    
    echo -n "."
    > ${FILENET}
    echo "ifconfig"        >> ${FILENET}
    ${IFCONFIG}            >> ${FILENET}
    echo "route"           >> ${FILENET}
    ${ROUTE}               >> ${FILENET}
    echo "route -A inet6"  >> ${FILENET}
    ${ROUTE} -A inet6      >> ${FILENET}
    echo "ip link"         >> ${FILENET}
    ${IP} link             >> ${FILENET}
    echo "ip addr"         >> ${FILENET}
    ${IP} addr             >> ${FILENET}
    echo "ip addr"         >> ${FILENET}
    ${IP} route            >> ${FILENET}
    echo "ip -6 route"     >> ${FILENET}
    ${IP} -6 route         >> ${FILENET}
    echo "ip tunnel"       >> ${FILENET}
    ${IP} tunnel           >> ${FILENET}
    cat-file /proc/net/dev         ${FILENET}
    cat-file /proc/net/dev_mcast   ${FILENET}
    cat-file /proc/net/protocols   ${FILENET}
    cat-file /proc/sys/net/ipv4/ip_forward                  ${FILENET}
    cat-file /proc/sys/net/ipv4/neigh/default/gc_interval   ${FILENET}
    cat-file /proc/sys/net/ipv4/neigh/default/gc_stale_time ${FILENET} 
    cat-file /proc/sys/net/ipv4/neigh/default/gc_thresh1    ${FILENET}
    cat-file /proc/sys/net/ipv4/neigh/default/gc_thresh2    ${FILENET}
    cat-file /proc/sys/net/ipv4/neigh/default/gc_thresh3    ${FILENET}
    cat-file /proc/sys/net/ipv6/conf/all/forwarding         ${FILENET}
    cat-file /proc/sys/net/ipv6/conf/all/mtu                ${FILENET}
    cat-file /proc/sys/net/ipv6/neigh/default/gc_interval   ${FILENET}
    cat-file /proc/sys/net/ipv6/neigh/default/gc_stale_time ${FILENET} 
    cat-file /proc/sys/net/ipv6/neigh/default/gc_thresh1    ${FILENET}
    cat-file /proc/sys/net/ipv6/neigh/default/gc_thresh2    ${FILENET}
    cat-file /proc/sys/net/ipv6/neigh/default/gc_thresh3    ${FILENET}
}


if [ -d ${DIARIO} ] ; then
    echo -n "Updating "
    packages-list-update
    partition-update
    lvm-update
    md-update
    kernel-update
    kernel-boot
    hardware-update
    hpacucli-update-7.6
    net-update
    echo " Done"
else
    echo "Don't exist ${DIARIO} directory, not running"
fi

